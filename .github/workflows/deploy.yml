name: CI

on:
  push:
    branches: [ '*' ]
  pull_request:

permissions:
  contents: read

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Install PowerShell modules
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          if (-not (Get-Module -ListAvailable -Name Pester)) {
            Install-Module -Name Pester -Force -Scope CurrentUser
          }

      - name: Run Pester tests
        id: pester
        shell: pwsh
        run: |
          Import-Module Pester
          $Config = New-PesterConfiguration
          $Config.Run.Path = "./src/tests"
          $Config.Run.Exit = $false
          $Config.Run.PassThru = $true
          $Config.TestResult.Enabled = $true
          $Config.TestResult.OutputPath = "TestResults.xml"
          $Config.TestResult.OutputFormat = "JUnitXml"
          $Result = Invoke-Pester -Configuration $Config
          
          # Write to Job Summary
          $Summary = "## üß™ Pester Test Results`n`n"
          $Summary += "| ‚úÖ Passed | ‚ùå Failed | ‚è≠Ô∏è Skipped | Total |`n"
          $Summary += "|-----------|-----------|------------|-------|`n"
          $Summary += "| $($Result.PassedCount) | $($Result.FailedCount) | $($Result.SkippedCount) | $($Result.TotalCount) |`n"
          
          if ($Result.FailedCount -gt 0) {
            $Summary += "`n### Failed Tests`n`n"
            foreach ($test in $Result.Failed) {
              $Summary += "- **$($test.Name)**`n"
              $Summary += "  - $($test.ErrorRecord.Exception.Message)`n"
            }
          }
          
          $Summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          
          if ($Result.FailedCount -gt 0) {
            exit 1
          }

      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: test-results
          path: TestResults.xml

  security:
    name: Run Security Analysis
    needs: test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
          $Results = Invoke-ScriptAnalyzer -Path ./src -Recurse -ReportSummary
          
          $Errors = $Results | Where-Object Severity -eq 'Error'
          $Warnings = $Results | Where-Object Severity -eq 'Warning'
          $Info = $Results | Where-Object Severity -eq 'Information'
          
          $Summary = "## üîç PSScriptAnalyzer Results`n`n"
          $Summary += "| ‚ùå Errors | ‚ö†Ô∏è Warnings | ‚ÑπÔ∏è Info |`n"
          $Summary += "|-----------|-------------|---------|`n"
          $Summary += "| $($Errors.Count) | $($Warnings.Count) | $($Info.Count) |`n"
          
          if ($Errors) {
            $Summary += "`n### Errors`n`n"
            $Summary += "| Rule | File | Line |`n"
            $Summary += "|------|------|------|`n"
            foreach ($r in $Errors) {
              $File = $r.ScriptPath -replace '.*[/\\]src[/\\]', 'src/'
              $Summary += "| $($r.RuleName) | $File | $($r.Line) |`n"
            }
          } else {
            $Summary += "`n‚úÖ **No errors!**`n"
          }
          
          $Summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          
          if ($Results) {
            $Results | Format-Table
            if ($Errors.Count -gt 0) {
              Write-Host "Script analysis found errors!" -ForegroundColor Red
              exit 1
            }
            Write-Host "Script analysis found warnings (non-blocking)" -ForegroundColor Yellow
          }

  should-deploy:
    name: Release Gate
    needs:
      - test
      - security
    if: github.event.repository.fork == false && github.ref_name == 'main'
    runs-on: ubuntu-latest
    steps:
      - run: echo "Deployment checks passed"

  build:
    name: Publish Module to PowerShell Gallery
    needs: should-deploy

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Publish PowerShell Module
        uses: chris-peterson/publish-powershell-modules@v1
        with:
          ApiKey: ${{ secrets.PSGALLERY_API_KEY }}
    environment:
      name: PowerShell Gallery
      url: https://www.powershellgallery.com/packages/GitlabCli

  docker:
    name: Publish Docker Image to GitHub Container Registry
    needs: should-deploy

    env:
      IMAGE_NAME: gitlab-cli
      REGISTRY: ghcr.io
      IMAGE_ID: ghcr.io/${{ github.repository }}/gitlab-cli

    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write
      attestations: write
      artifact-metadata: write
      id-token: write

    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.12.0

      - name: Log into registry
        uses: docker/login-action@v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5.10.0
        with:
          images: ${{ env.IMAGE_ID }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v6.18.0
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v3.1.0
        with:
          subject-name: ${{ env.IMAGE_ID }}
          subject-digest: ${{ steps.build.outputs.digest }}
          push-to-registry: true
